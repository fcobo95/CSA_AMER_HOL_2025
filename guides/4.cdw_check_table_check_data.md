# Cloudera Data Warehouse - Understanding our Iceberg table and validating some data
In this step, we will be checking the format of the table and also validate some data to understand the customer churn behavior. 

### Checking table data row count, data format, and describing your Iceberg table
First off, let’s check how many records we have in our table:

```sql
SELECT COUNT(*) 
FROM ${CSA_ALIAS}.telco_iceberg_kafka;
```

Let’s select data to verify the values were properly inserted: 

```sql
SELECT * 
FROM ${CSA_ALIAS}.telco_iceberg_kafka;
```

Now, let’s describe our table to understand whether or not we are using Iceberg format:
```sql
DESCRIBE FORMATTED ${CSA_ALIAS}.telco_iceberg_kafka;
```

Let’s analyze our table starting from row #23, which has a detailed list of table information. For example:

| Field        | Value                                                                                                                      |
|--------------|----------------------------------------------------------------------------------------------------------------------------|
| Database     | fcobo                                                                                                                      |
| OwnerType    | USER                                                                                                                       |
| ...          | ...                                                                                                                        |
| Location     | abfs://data@go01demoazure.dfs.core.windows.net/warehouse/tablespace/external/hive/fcobo.db/telco_iceberg_kafka             |
| Table Type   | EXTERNAL_TABLE                                                                                                             |
| table_type   | ICEBERG                                                                                                                    |

### Querying data to understand customer churn
In this section, we will be running some queries to test hypotheses and validate if they are right or wrong, using the power of data.

#### Step 1 - Calculate churn rate by contract type 

This helps to determine if a customer's contract length is a strong predictor of churn.

```sql
SELECT
  Contract,
  COUNT(*) AS total_customers,
  SUM(CASE WHEN Churn = 'Yes' THEN 1 ELSE 0 END) AS churned_customers,
  CAST(SUM(CASE WHEN Churn = 'Yes' THEN 1 ELSE 0 END) AS DOUBLE) / COUNT(*) AS churn_rate
FROM ${CSA_ALIAS}.telco_iceberg_kafka
GROUP BY Contract
ORDER BY churn_rate DESC;
```

#### Step 2 - Compare average monthly and total charges for churned versus non-churned customers 

This helps to see if spending habits correlate with churn.

```sql
SELECT
  Churn,
  AVG(CAST(MonthlyCharges AS DOUBLE)) AS avg_monthly_charges,
  AVG(CAST(TotalCharges AS DOUBLE)) AS avg_total_charges
FROM ${CSA_ALIAS}.telco_iceberg_kafka
GROUP BY Churn;
```

#### Step 3 - Analyze churn rate by customer tenure by grouping customers into tenure bins. 

This helps visualize if newer customers churn more frequently.

```sql
SELECT
  CASE
    WHEN CAST(tenure AS INT) <= 12 THEN '0-12 months'
    WHEN CAST(tenure AS INT) > 12 AND CAST(tenure AS INT) <= 24 THEN '13-24 months'
    WHEN CAST(tenure AS INT) > 24 AND CAST(tenure AS INT) <= 48 THEN '25-48 months'
    WHEN CAST(tenure AS INT) > 48 THEN '49+ months'
    ELSE 'Unknown'
  END AS tenure_group,
  COUNT(*) AS total_customers,
  SUM(CASE WHEN Churn = 'Yes' THEN 1 ELSE 0 END) AS churned_customers,
  CAST(SUM(CASE WHEN Churn = 'Yes' THEN 1 ELSE 0 END) AS DOUBLE) / COUNT(*) AS churn_rate
FROM ${CSA_ALIAS}.telco_iceberg_kafka
GROUP BY
  CASE
    WHEN CAST(tenure AS INT) <= 12 THEN '0-12 months'
    WHEN CAST(tenure AS INT) > 12 AND CAST(tenure AS INT) <= 24 THEN '13-24 months'
    WHEN CAST(tenure AS INT) > 24 AND CAST(tenure AS INT) <= 48 THEN '25-48 months'
    WHEN CAST(tenure AS INT) > 48 THEN '49+ months'
    ELSE 'Unknown'
  END
ORDER BY tenure_group;
```